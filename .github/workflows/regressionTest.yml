name: Regression Tests
on: 
  workflow_dispatch:

jobs:
  Regression-Tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        containers: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Packages
        run:  npm install

      - name: Generate .env file
        run: |
          cat > .env <<EOF
          ${{ secrets.PRO_ENV_FILE }}
          EOF

      - name: Cleanup reports
        run:  npm run clean-reports

      - name: Run Tests
        run:  npx cypress run --config-file ci-cypress.config.ts --spec $(node regression-parallel.ts ${{ matrix.containers }} 19) --browser chrome
      
      - name: Upload Cypress Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-reports-${{ matrix.containers }}
          path: cypress/reports/

  merge-reports:
    needs: Regression-Tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Cypress Report 0
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-0
          path: cypress/reports/cypress-reports-0

      - name: Download Cypress Report 1
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-1
          path: cypress/reports/cypress-reports-1

      - name: Download Cypress Report 2
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-2
          path: cypress/reports/cypress-reports-2

      - name: Download Cypress Report 3
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-3
          path: cypress/reports/cypress-reports-3

      - name: Download Cypress Report 4
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-4
          path: cypress/reports/cypress-reports-4

      - name: Download Cypress Report 5
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-5
          path: cypress/reports/cypress-reports-5

      - name: Download Cypress Report 6
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-6
          path: cypress/reports/cypress-reports-6

      - name: Download Cypress Report 7
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-7
          path: cypress/reports/cypress-reports-7

      - name: Download Cypress Report 8
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-8
          path: cypress/reports/cypress-reports-8

      - name: Download Cypress Report 9
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-9
          path: cypress/reports/cypress-reports-9

      - name: Download Cypress Report 10
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-10
          path: cypress/reports/cypress-reports-10

      - name: Download Cypress Report 11
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-11
          path: cypress/reports/cypress-reports-11

      - name: Download Cypress Report 12
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-12
          path: cypress/reports/cypress-reports-12

      - name: Download Cypress Report 13
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-13
          path: cypress/reports/cypress-reports-13

      - name: Download Cypress Report 14
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-14
          path: cypress/reports/cypress-reports-14

      - name: Download Cypress Report 15
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-15
          path: cypress/reports/cypress-reports-15

      - name: Download Cypress Report 16
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-16
          path: cypress/reports/cypress-reports-16

      - name: Download Cypress Report 17
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-17
          path: cypress/reports/cypress-reports-17

      - name: Download Cypress Report 18
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: cypress-reports-18
          path: cypress/reports/cypress-reports-18    

      - name: Collect Cypress Intermediate Reports
        if: always()
        run: |
          mkdir -p cypress/reports/all
          for i in {0..18}; do
            rsync -av --ignore-existing cypress/reports/cypress-reports-$i/* cypress/reports/all/
          done

      - name: Install Packages
        if: always()
        run:  npm install --save-dev mochawesome-merge marge cypress-multi-reporters    

      - name: Merge Cypress Reports
        if: always()
        run: |
          npm run final_report
          echo "DATE=$(date +'%d-%B-%Y')" >> $GITHUB_ENV

      - name: Cleanup Intermediate Reports
        if: always()
        run: rm -rf cypress/reports/all/*.json

      # Deleting Intermediate Reports Artifacts
      - uses: geekyeggo/delete-artifact@v5
        with:
          failOnError: false
          name: |
              cypress-reports-0
              cypress-reports-1
              cypress-reports-2
              cypress-reports-3
              cypress-reports-4
              cypress-reports-5
              cypress-reports-6
              cypress-reports-7
              cypress-reports-8
              cypress-reports-9
              cypress-reports-10
              cypress-reports-11
              cypress-reports-12
              cypress-reports-13
              cypress-reports-14
              cypress-reports-15
              cypress-reports-16
              cypress-reports-17
              cypress-reports-18

      - name: Upload Cypress Merged Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Regression-Test-Report-${{ env.DATE }}
          path: cypress/reports/all/
